name: Supply Chain Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: rock-paper-scissors
  TRIVY_DISABLE_VEX_NOTICE: "true"

jobs:
  prep_and_scan:
    name: Prep & Scan
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show workspace layout
        run: |
          pwd
          ls -la

      - name: Setup Task runner
        uses: arduino/setup-task@v1

      - name: Prepare Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Install Trivy scanner
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Ensure Trivy ignore file exists
        run: |
          if [ ! -f .trivyignore ]; then
            echo "WARN: .trivyignore missing in checkout; creating empty file"
            : > .trivyignore
          fi
          ls -la .trivyignore

      - name: Run baseline scans (Trivy fs/iac)
        run: |
          mkdir -p attestations
          # Scan repo root so dependency files (e.g. requirements.txt) are included
          # Skip local virtualenvs, otherwise Trivy reports CVEs from dev env packages
          trivy fs --ignorefile ./.trivyignore \
            --skip-dirs .git \
            --skip-dirs attestations \
            --skip-dirs venv \
            --skip-dirs .venv \
            --format cosign-vuln . > attestations/vuln-source.json
          if [ -d src/docker ]; then
            trivy config --format cosign-vuln src/docker/ > attestations/vuln-dockerfile.json || true
          else
            echo '{}' > attestations/vuln-dockerfile.json
            echo "skip: src/docker not found"
          fi
          if [ -d src/iac ]; then
            trivy config --format cosign-vuln src/iac/ > attestations/vuln-iac.json || true
          else
            echo '{}' > attestations/vuln-iac.json
            echo "skip: src/iac not found"
          fi

      - name: Build app image (for vuln scan)
        run: docker build --no-cache -t rock-paper-scissors:latest -f src/docker/Dockerfile .

      - name: Show Python package versions in image
        run: |
          docker run --rm rock-paper-scissors:latest python -m pip show wheel jaraco.context || true

      - name: Scan image and enforce HIGH/CRITICAL policy
        run: |
          trivy image --ignorefile ./.trivyignore --severity HIGH,CRITICAL --exit-code 1 rock-paper-scissors:latest
          trivy image --ignorefile ./.trivyignore --format cosign-vuln rock-paper-scissors:latest > attestations/vuln-image.json

      - name: Upload attestation bundle
        uses: actions/upload-artifact@v4
        with:
          name: attestations
          path: attestations/

  build_and_push:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: prep_and_scan
    outputs:
      image: ${{ steps.meta.outputs.image }}
      digest: ${{ steps.push.outputs.digest }}
      image_ref: ${{ steps.meta.outputs.image }}@${{ steps.push.outputs.digest }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image ref
        id: meta
        run: |
          OWNER_LOWER="${{ github.repository_owner }}"
          IMAGE="ghcr.io/${OWNER_LOWER,,}/${{ env.IMAGE_NAME }}"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"

      - name: Docker Buildx (push with provenance + SBOM)
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./src/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.image }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: true

  sign_and_verify:
    name: Sign & Verify
    runs-on: ubuntu-latest
    needs: build_and_push
    env:
      IMAGE_REF: ${{ needs.build_and_push.outputs.image_ref }}
      IMAGE_DIGEST: ${{ needs.build_and_push.outputs.digest }}
    steps:
      - name: Login to GHCR (for cosign)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download attestation bundle
        uses: actions/download-artifact@v4
        with:
          name: attestations
          path: attestations

      - name: Install Cosign
        uses: sigstore/cosign-installer@v2
        with:
          cosign-release: 'v2.4.0'

      - name: Sign container (keyless)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          echo "Signing ${IMAGE_REF}"
          cosign sign --yes "${IMAGE_REF}"

      - name: Attach vulnerability attestations (Trivy)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          # Provenance + SBOM are already attached by docker/build-push-action (provenance/sbom settings).
          # Here we attach the Trivy-based vuln attestations generated in prep_and_scan.
          for TYPE in vuln-source vuln-dockerfile vuln-iac vuln-image; do
            case $TYPE in
              vuln-source) PRED=attestations/vuln-source.json; T=https://cosign.dev/attestation/vuln/source ;;
              vuln-dockerfile) PRED=attestations/vuln-dockerfile.json; T=https://cosign.dev/attestation/vuln/dockerfile ;;
              vuln-iac) PRED=attestations/vuln-iac.json; T=https://cosign.dev/attestation/vuln/iac ;;
              vuln-image) PRED=attestations/vuln-image.json; T=https://cosign.dev/attestation/vuln/image ;;
            esac
            cosign attest --yes --type "$T" --predicate "$PRED" "${IMAGE_REF}"
          done

      - name: Verify signature
        run: |
          cosign verify --experimental-oci11 \
            --certificate-identity-regexp="https://github.com/.+" \
            --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
            "${IMAGE_REF}"

      - name: Verify attestations (all)
        run: |
          for TYPE in \
            "https://slsa.dev/provenance/v0.2" \
            "https://spdx.dev/Document" \
            "https://cosign.dev/attestation/vuln/source" \
            "https://cosign.dev/attestation/vuln/dockerfile" \
            "https://cosign.dev/attestation/vuln/iac" \
            "https://cosign.dev/attestation/vuln/image"; do
            cosign verify-attestation --experimental-oci11 \
              --type "$TYPE" \
              --certificate-identity-regexp="https://github.com/.+" \
              --certificate-oidc-issuer-regexp="https://token.actions.githubusercontent.com" \
              "${IMAGE_REF}" > /dev/null
          done
          echo "‚úÖ All attestations verified."

      - name: Check Rekor for expected entries
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          HASH="${IMAGE_DIGEST#sha256:}"
          echo "üîç Searching Rekor for $HASH"
          docker run --rm ghcr.io/sigstore/rekor-cli:latest search --sha "$HASH" --format json > rekor-output.json
          cat rekor-output.json | jq
          ENTRY_COUNT=$(jq length rekor-output.json)
          if [ "$ENTRY_COUNT" -lt 6 ]; then
            echo "‚ùå Rekor entry count less than 6)" && exit 1
          fi
          echo "‚úÖ Rekor has at least 6 entries."

      - name: Upload Rekor output
        uses: actions/upload-artifact@v4
        with:
          name: rekor-output
          path: rekor-output.json
